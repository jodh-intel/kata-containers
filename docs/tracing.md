* [Overview](#overview)
* [Introduction](#introduction)
* [OpenTelemetry summary](#opentelemetry-summary)
* [Architecture](#architecture)
    * [Runtime tracing architecture](#runtime-tracing-architecture)
    * [Agent tracing architecture](#agent-tracing-architecture)
* [Agent tracing terminology](#agent-tracing-terminology)
    * [Trace modes](#trace-modes)
    * [Trace types](#trace-types)
* [Prerequisites](#prerequisites)
* [Enable tracing](#enable-tracing)
    * [Enable runtime tracing](#enable-runtime-tracing)
    * [Enable agent tracing](#enable-agent-tracing)
        * [Enable static agent tracing](#enable-static-agent-tracing)
        * [Enable dynamic agent tracing](#enable-dynamic-agent-tracing)
* [Appendices](#appendices)
    * [Agent tracing requirements](#agent-tracing-requirements)
        * [Host environment](#host-environment)
        * [Guest environment](#guest-environment)
    * [Agent tracing limitations](#agent-tracing-limitations)
    * [Performance impact](#performance-impact)
    * [Agent shutdown behaviour](#agent-shutdown-behaviour)
    * [Set up a tracing development environment](#set-up-a-tracing-development-environment)

# Overview

This document explains how to trace Kata Containers components.

> **Warning:**
>
> This document explains the planned set of tracing features. However, tracing
> support in the agent is still under development. Initially,
> [_static isolated_ tracing is being added](https://github.com/kata-containers/kata-containers/pull/1929).
> The remaining trace work items are tracked in the
> [tracing GitHub project](https://github.com/orgs/kata-containers/projects/28).

# Introduction

The Kata Containers runtime and agent are able to generate
[OpenTelemetry][opentelemetry] trace spans, which allow the administrator to
observe what they are doing and how much time they are spending on each
activity.

# OpenTelemetry summary

An OpenTelemetry-enabled application creates a number of trace "spans". A span
contains the following attributes:

- A name
- A pair of timestamps (recording the start time and end time of some operation)
- A reference to the span's parent span

All spans need to be *finished*, or *completed*, to allow the OpenTelemetry
framework to generate the final trace information (by effectively closing the
transaction encompassing the initial (root) span and all its children).

# Architecture

## Runtime tracing architecture

The runtime, which runs in the host environment, has been modified to generate
trace spans which are sent to a trace collector on the host.

## Agent tracing architecture

The Kata Containers agent runs inside a virtual machine (VM). An OpenTelemetry
system (such as [Jaeger][jaeger-tracing]) uses a collector to gather up trace
spans for viewing and processing.

To avoid having to insert a trace collector inside the VM image, the Kata
Containers agent sends the trace spans generated by the agent to the [trace
forwarder][trace-forwarder], which runs in the host environment. The forwarder
then sends the spans to the trace collector, which also runs in the host
environment. The communications between the agent and the trace forwarder are
handled using a [`VSOCK`][vsock] channel.

> **Note:**
>
> This design supports agent tracing without having to make changes to the
> image, but also means that [custom images][osbuilder] can also benefit from
> agent tracing.

The following diagram summarises the architecture used to trace the
Kata Containers agent:

```
+-------------------------------------------+
| Host                                      |
|                                           |
| +-----------+                             |
| | Trace     |                             |
| | Collector |                             |
| +-----+-----+                             |
|       ^                  +--------------+ |
|       | spans            | Kata VM      | |
| +-----+-----+            |              | |
| | Kata      |    spans   |     +-----+  | |
| | Trace     |<-----------------|Kata |  | |
| | Forwarder |    VSOCK   |     |Agent|  | |
| +-----------+    Channel |     +-----+  | |
|                          +--------------+ |
+-------------------------------------------+
```

# Agent tracing terminology

## Trace modes

The agent supports two different tracing modes:

| Trace mode | Description | Use-case | Setting | VM shutdown controller | Notes |
|-|-|-|-|-|-|
| Static | Traces from agent start to agent shutdown. | Holistic view of agent activities. Possibly more suited to short-running containers. | `trace_mode = "static"` | agent | Default trace mode. |
| Dynamic | Traces begin when the ttRPC `StartTracing()` API is called and end when the corresponding `StopTracing()` API is called. | On-demand (partial) tracing. More appropriate for long-running containers. | `trace_mode = "dynamic"` | runtime | Only "isolated" type supported. |

## Trace types

Each trace mode is sub-divided into two different types:

| Trace type | Description | Use-case | Setting | Notes |
|-|-|-|-|-|
| isolated | The traces only apply to the agent: the first span is generated at agent startup and the last at agent shutdown. | Observing agent lifespan. | `trace_type = "isolated"` | Default trace type. |
| collated | In this mode, spans are associated with their Kata runtime initiated counterparts. | Understanding how the runtime and agent interact. | `trace_type = "collated"` | Also requires runtime tracing to be enabled in `configuration.toml` (`enable_tracing=true`). |

# Prerequisites

- You must have a trace collector running on the host.

  The quickest and simplest method for doing this is to use the
  [Jaeger "all-in-one" Docker image][jaeger-all-in-one].

- If you wish to trace the agent, you must start the
  [trace forwarder][trace-forwarder].

> **Notes:**
>
> - If agent tracing is enabled but the forwarder is not running,
>   the agent will exit (panic) with an error message. Since the agent is not
>   directly visible by the user, it is recommended to enable debug to capture
>   this message in the logs.
>
> - The forwarder requires a trace collector (such as Jaeger) to be running
>   before it is started. If a collector is not running, the trace forwarder
>   will exit with an error.

# Enable tracing

By default, tracing is disabled for all components. To enable _any_ form of
tracing the `enable_tracing` option must be enabled.

> **Note:** 
>
> Enabling this option will only allow tracing for subsequently
> started components.

## Enable runtime tracing

To trace the runtime, simply set the tracing option as shown:

```toml
[runtime]
enable_tracing = true
```

## Enable agent tracing

The agent may require more configuration than the runtime. However, the simplest way to trace the agent is to enable it tracing option:

```toml
[agent.kata]
enable_tracing = true
```

If no other trace options are specified this will enable _static isolated_
tracing.

> **Note:**
>
> Agent tracing is separate from the tracing for other Kata Containers
> components. It is not necessary to enable runtime tracing if you want to
> enable agent tracing (or _vice versa_). However, "collated" mode tracing
> only works as documented if runtime tracing is also enabled.

### Enable static agent tracing

- Enable tracing in the `configuration.toml` configuration file:

  ```toml
  [agent.kata]
  enable_tracing = true
  trace_mode = "static"

  # Uncomment one of the following
  ##trace_type = "isolated" # default
  ##trace_type = "collated"
  ```

- Create a container.

### Enable dynamic agent tracing

- Enable tracing in the `configuration.toml` configuration file:

  ```toml
  [agent.kata]
  enable_tracing = true
  trace_mode = "dynamic"

  # Uncomment one of the following
  ##trace_type = "isolated" # default
  ##trace_type = "collated"
  ```

- Call the ttRPC `StartTracing()` API to start tracing and the corresponding
  `StopTracing()` API to stop tracing.

> **Notes:**
> 
> - The dynamic tracing mode will always use an isolated type.
> - If tracing is not enabled, calling the dynamic tracing ttRPC APIs will
>   have no effect.
> - Dynamic tracing can be toggled on and off using the Kata
>   [agent control tool][agent-ctl].

# Appendices

## Agent tracing requirements

### Host environment

- Host kernel must support the VSOCK socket type.

  This will be available if the kernel is built with the
  `CONFIG_VHOST_VSOCK` configuration option.

- VSOCK kernel module must be loaded:

   ```
   $ sudo modprobe vhost_vsock
   ```

### Guest environment

- Guest kernel must support the VSOCK socket type:

  This will be available if the kernel is built with the
  `CONFIG_VIRTIO_VSOCKETS` configuration option.

## Agent tracing limitations

- Agent tracing is only "completed" when the workload and the Kata agent
  process have exited.

  Although trace information *can* be inspected before the workload and agent
  have exited, it is incomplete. This is shown as `<trace-without-root-span>`
  in the Jaeger UI. Dynamic tracing will be incomplete (by definition).

  If the workload is still running, the trace transaction -- which spans the entire
  runtime of the Kata agent -- will not have been completed. To view the complete
  trace details, first stop the Kata Container.

## Performance impact

[OpenTelemetry][opentelemetry] is designed for high performance. It combines
the best of two older projects (OpenTracing and OpenCensus) and uses a very
efficient mechanism to capture trace spans. Further, the trace points inserted
into the agent are generated dynamically at compile time. This is advantageous
since new versions of the agent will automatically benefit from improvements
in the tracing infrastructure. Overall, the impact of enabling runtime and
agent tracing should be extremely low.

## Agent shutdown behaviour
 
As shown in the [trace modes](#trace-modes) section, the different trace modes
change how the VM is shutdown. In normal operation, the Kata runtime manages
the VM shutdown. The **only** scenario the agent itself is responsible for VM
shutdown is if static tracing is enabled. In this scenario, the agent finishes
the trace spans and actually exits. If an initrd is used, this causes the
agent (which is running as PID 1) to exit, which causes the kernel to halt. If
an image is being used (the default), the systemd unit that launches the Kata
agent detects this and then runs the `ExecStop=` command, which shuts down the
VM.

## Set up a tracing development environment

If you want to debug, further develop, or test tracing,
[enabling full debug][enable-full-debug]
is highly recommended. For working with the agent, you may also wish to
[enable a debug console][setup-debug-console]
to allow you to access the VM environment.

[agent-ctl]: https://github.com/kata-containers/kata-containers/blob/main/tools/agent-ctl
[enable-full-debug]: https://github.com/kata-containers/kata-containers/blob/main/docs/Developer-Guide.md#enable-full-debug
[jaeger-all-in-one]: https://www.jaegertracing.io/docs/getting-started/
[jaeger-tracing]: https://www.jaegertracing.io
[opentelemetry]: https://opentelemetry.io
[osbuilder]: https://github.com/kata-containers/kata-containers/blob/main/tools/osbuilder
[setup-debug-console]: https://github.com/kata-containers/kata-containers/blob/main/docs/Developer-Guide.md#set-up-a-debug-console
[trace-forwarder]: https://github.com/kata-containers/kata-containers/blob/main/src/trace-forwarder
[vsock]: https://www.qemu.org/Features/VirtioVsock
